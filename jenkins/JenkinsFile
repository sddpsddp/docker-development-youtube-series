def pkg
def publishVersion
def label = "jenkins-slave"

podTemplate (label: label, idleMinutes: 60, containers: [
               containerTemplate(name: 'jnlp', image: 'dockernaveensddp/jnlp:2.0.0', runAsUser: '0', ttyEnabled: true),
             ]) {

  node(label) {
    def repo = checkout scm

    withEnv([
             'KUBECONFIG=/mnt/kubeconfig/kubeconfig.json'
            ]) {

      try {
        stage("Test pipeline") {
          container('jnlp') {
            echo "testing pod template"
            sh(script: """
                echo "hello, i am CKA certified"
                echo "kubectl version --short"
                git clone https://github.com/marcel-dempers/docker-development-youtube-series.git
                cd ./docker-development-youtube-series/jenkins/dockerfiles
                
                echo "docker build . -t dockernaveensddp/jnlp:2.0.0"
                echo "docker login -u dockernaveensddp -p sddpsddp44"
                echo "docker push dockernaveensddp/jnlp:2.0.0"
                
                
                """)
                
          }
        }

        stage("Deployment") {
          if (repo.GIT_BRANCH == "master") {
           container('jnlp') {
             echo "find . -name '*templates*' -prune -o -name '*.yaml' -exec kubectl apply -f \\{\\} \\;"
           }
          }
        }
      }
      catch(Exception ex) { currentBuild = "FAILURE" }
      finally { 
        if (currentBuild.result == 'FAILURE') {
          office365ConnectorSend(
          message: "Build failed in project ${env.JOB_NAME}",
          status: "FAILURE",
          webhookUrl: "${env.HYPER_TEAMS_WEBHOOK}",
          color: "d31547"
          )
      }
    }
  }
}

